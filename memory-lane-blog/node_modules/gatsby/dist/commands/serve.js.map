{"version":3,"file":"serve.js","names":["readMatchPaths","program","filePath","path","join","directory","rawJSON","fs","readFile","error","report","warn","chalk","bold","JSON","parse","matchPathRouter","matchPaths","options","req","res","next","url","accepts","matchPath","find","reachMatch","sendFile","err","module","exports","initTracer","process","env","GATSBY_OPEN_TRACING_CONFIG_FILE","openTracingConfigFile","prefixPaths","port","open","host","parseInt","configModule","getConfigFile","config","preferDefault","pathPrefix","configPathPrefix","trailingSlash","root","app","express","partytownProxiedURLs","use","thirdPartyProxyPath","partytownProxy","router","Router","compression","configureTrailingSlash","pages","get","pathName","getDataStore","getNode","values","iterateNodesByType","static","dotfiles","compiledFunctionsDir","functions","readFileSync","e","functionMiddlewaresInstances","functionMiddlewares","getFunctions","graphqlEnginePath","pageSSRModule","require","resolve","posix","slash","GraphQLEngine","getData","renderPageData","renderHTML","findEnginePageByPath","graphqlEngine","dbPath","requestedPagePath","params","pagePath","potentialPagePath","reverseFixedPagePath","page","mode","requestActivity","phantomActivity","start","spanContext","span","context","data","results","serverDataHeaders","name","value","Object","entries","setHeader","serverDataStatus","status","send","contentType","end","panic","id","_","header","printInstructions","appName","urls","console","log","lanUrlForTerminal","localUrlForTerminal","startListening","listen","prepareUrls","ssl","sitePackageJson","info","Promise","openurl","localUrlForBrowser","catch","detectPortInUseAndPrompt","message"],"sources":["../../src/commands/serve.ts"],"sourcesContent":["import path from \"path\"\nimport openurl from \"better-opn\"\nimport fs from \"fs-extra\"\nimport compression from \"compression\"\nimport express from \"express\"\nimport chalk from \"chalk\"\nimport { match as reachMatch } from \"@gatsbyjs/reach-router\"\nimport report from \"gatsby-cli/lib/reporter\"\n\nimport { detectPortInUseAndPrompt } from \"../utils/detect-port-in-use-and-prompt\"\nimport { getConfigFile } from \"../bootstrap/get-config-file\"\nimport { preferDefault } from \"../bootstrap/prefer-default\"\nimport { IProgram } from \"./types\"\nimport { IPreparedUrls, prepareUrls } from \"../utils/prepare-urls\"\nimport {\n  IGatsbyConfig,\n  IGatsbyFunction,\n  IGatsbyPage,\n  IGatsbyState,\n} from \"../redux/types\"\nimport { reverseFixedPagePath } from \"../utils/page-data\"\nimport { initTracer } from \"../utils/tracer\"\nimport { configureTrailingSlash } from \"../utils/express-middlewares\"\nimport { getDataStore } from \"../datastore\"\nimport { functionMiddlewares } from \"../internal-plugins/functions/middleware\"\nimport {\n  thirdPartyProxyPath,\n  partytownProxy,\n} from \"../internal-plugins/partytown/proxy\"\nimport { slash } from \"gatsby-core-utils/path\"\n\ninterface IMatchPath {\n  path: string\n  matchPath: string\n}\n\ninterface IServeProgram extends IProgram {\n  prefixPaths: boolean\n}\n\nconst readMatchPaths = async (\n  program: IServeProgram\n): Promise<Array<IMatchPath>> => {\n  const filePath = path.join(program.directory, `.cache`, `match-paths.json`)\n  let rawJSON = `[]`\n  try {\n    rawJSON = await fs.readFile(filePath, `utf8`)\n  } catch (error) {\n    report.warn(error)\n    report.warn(\n      `Could not read ${chalk.bold(\n        `match-paths.json`\n      )} from the .cache directory`\n    )\n    report.warn(\n      `Client-side routing will not work correctly. Maybe you need to re-run ${chalk.bold(\n        `gatsby build`\n      )}?`\n    )\n  }\n  return JSON.parse(rawJSON) as Array<IMatchPath>\n}\n\nconst matchPathRouter =\n  (\n    matchPaths: Array<IMatchPath>,\n    options: {\n      root: string\n    }\n  ) =>\n  (\n    req: express.Request,\n    res: express.Response,\n    next: express.NextFunction\n  ): void => {\n    const { url } = req\n    if (req.accepts(`html`)) {\n      const matchPath = matchPaths.find(\n        ({ matchPath }) => reachMatch(matchPath, url) !== null\n      )\n      if (matchPath) {\n        return res.sendFile(\n          path.join(matchPath.path, `index.html`),\n          options,\n          err => {\n            if (err) {\n              next()\n            }\n          }\n        )\n      }\n    }\n    return next()\n  }\n\nmodule.exports = async (program: IServeProgram): Promise<void> => {\n  await initTracer(\n    process.env.GATSBY_OPEN_TRACING_CONFIG_FILE || program.openTracingConfigFile\n  )\n  let { prefixPaths, port, open, host } = program\n  port = typeof port === `string` ? parseInt(port, 10) : port\n\n  const { configModule } = await getConfigFile(\n    program.directory,\n    `gatsby-config`\n  )\n  const config: IGatsbyConfig = preferDefault(configModule)\n\n  const { pathPrefix: configPathPrefix, trailingSlash } = config || {}\n\n  const pathPrefix = prefixPaths && configPathPrefix ? configPathPrefix : `/`\n\n  const root = path.join(program.directory, `public`)\n\n  const app = express()\n\n  // Proxy gatsby-script using off-main-thread strategy\n  const { partytownProxiedURLs = [] } = config || {}\n\n  app.use(thirdPartyProxyPath, partytownProxy(partytownProxiedURLs))\n\n  // eslint-disable-next-line new-cap\n  const router = express.Router()\n\n  router.use(compression())\n\n  router.use(\n    configureTrailingSlash(\n      () =>\n        ({\n          pages: {\n            get(pathName: string): IGatsbyPage | undefined {\n              return getDataStore().getNode(`SitePage ${pathName}`) as\n                | IGatsbyPage\n                | undefined\n            },\n            values(): Iterable<IGatsbyPage> {\n              return getDataStore().iterateNodesByType(\n                `SitePage`\n              ) as Iterable<IGatsbyPage>\n            },\n          },\n        } as unknown as IGatsbyState),\n      trailingSlash\n    )\n  )\n\n  router.use(express.static(`public`, { dotfiles: `allow` }))\n\n  const compiledFunctionsDir = path.join(\n    program.directory,\n    `.cache`,\n    `functions`\n  )\n\n  let functions: Array<IGatsbyFunction> = []\n  try {\n    functions = JSON.parse(\n      fs.readFileSync(path.join(compiledFunctionsDir, `manifest.json`), `utf-8`)\n    )\n  } catch (e) {\n    // ignore\n  }\n\n  if (functions) {\n    const functionMiddlewaresInstances = functionMiddlewares({\n      getFunctions(): Array<IGatsbyFunction> {\n        return functions\n      },\n    })\n\n    router.use(`/api/*`, ...functionMiddlewaresInstances)\n    // TODO(v6) remove handler from app and only keep it on router (router is setup on pathPrefix, while app is always root)\n    app.use(`/api/*`, ...functionMiddlewaresInstances)\n  }\n\n  // Handle SSR & DSG Pages\n  let graphqlEnginePath: string | undefined\n  let pageSSRModule: string | undefined\n  try {\n    graphqlEnginePath = require.resolve(\n      path.posix.join(slash(program.directory), `.cache`, `query-engine`)\n    )\n    pageSSRModule = require.resolve(\n      path.posix.join(slash(program.directory), `.cache`, `page-ssr`)\n    )\n  } catch (error) {\n    // TODO: Handle case of engine not being generated\n  }\n\n  if (graphqlEnginePath && pageSSRModule) {\n    try {\n      const { GraphQLEngine } =\n        require(graphqlEnginePath) as typeof import(\"../schema/graphql-engine/entry\")\n      const { getData, renderPageData, renderHTML, findEnginePageByPath } =\n        require(pageSSRModule) as typeof import(\"../utils/page-ssr-module/entry\")\n      const graphqlEngine = new GraphQLEngine({\n        dbPath: path.posix.join(\n          slash(program.directory),\n          `.cache`,\n          `data`,\n          `datastore`\n        ),\n      })\n\n      router.get(\n        `/page-data/:pagePath(*)/page-data.json`,\n        async (req, res, next) => {\n          const requestedPagePath = req.params.pagePath\n          if (!requestedPagePath) {\n            return void next()\n          }\n\n          const potentialPagePath = reverseFixedPagePath(requestedPagePath)\n          const page = findEnginePageByPath(potentialPagePath)\n\n          if (page && (page.mode === `DSG` || page.mode === `SSR`)) {\n            const requestActivity = report.phantomActivity(\n              `request for \"${req.path}\"`\n            )\n            requestActivity.start()\n            try {\n              const spanContext = requestActivity.span.context()\n              const data = await getData({\n                pathName: req.path,\n                graphqlEngine,\n                req,\n                spanContext,\n              })\n              const results = await renderPageData({ data, spanContext })\n              if (data.serverDataHeaders) {\n                for (const [name, value] of Object.entries(\n                  data.serverDataHeaders\n                )) {\n                  res.setHeader(name, value)\n                }\n              }\n\n              if (page.mode === `SSR` && data.serverDataStatus) {\n                return void res.status(data.serverDataStatus).send(results)\n              } else {\n                return void res.send(results)\n              }\n            } catch (e) {\n              report.error(\n                `Generating page-data for \"${requestedPagePath}\" / \"${potentialPagePath}\" failed.`,\n                e\n              )\n              return res\n                .status(500)\n                .contentType(`text/plain`)\n                .send(`Internal server error.`)\n            } finally {\n              requestActivity.end()\n            }\n          }\n\n          return void next()\n        }\n      )\n\n      router.use(async (req, res, next) => {\n        if (req.accepts(`html`)) {\n          const potentialPagePath = req.path\n          const page = findEnginePageByPath(potentialPagePath)\n          if (page && (page.mode === `DSG` || page.mode === `SSR`)) {\n            const requestActivity = report.phantomActivity(\n              `request for \"${req.path}\"`\n            )\n            requestActivity.start()\n\n            try {\n              const spanContext = requestActivity.span.context()\n              const data = await getData({\n                pathName: potentialPagePath,\n                graphqlEngine,\n                req,\n                spanContext,\n              })\n              const results = await renderHTML({ data, spanContext })\n              if (data.serverDataHeaders) {\n                for (const [name, value] of Object.entries(\n                  data.serverDataHeaders\n                )) {\n                  res.setHeader(name, value)\n                }\n              }\n\n              if (page.mode === `SSR` && data.serverDataStatus) {\n                return void res.status(data.serverDataStatus).send(results)\n              } else {\n                return void res.send(results)\n              }\n            } catch (e) {\n              report.error(\n                `Rendering html for \"${potentialPagePath}\" failed.`,\n                e\n              )\n              return res.status(500).sendFile(`500.html`, { root }, err => {\n                if (err) {\n                  res.contentType(`text/plain`).send(`Internal server error.`)\n                }\n              })\n            } finally {\n              requestActivity.end()\n            }\n          }\n        }\n        return next()\n      })\n    } catch (error) {\n      report.panic({\n        id: `98051`,\n        error,\n        context: {},\n      })\n    }\n  }\n\n  const matchPaths = await readMatchPaths(program)\n  router.use(matchPathRouter(matchPaths, { root }))\n\n  // TODO: Remove/merge with above same block\n  router.use((req, res, next) => {\n    if (req.accepts(`html`)) {\n      return res.status(404).sendFile(`404.html`, { root })\n    }\n    return next()\n  })\n  app.use(function (\n    _: express.Request,\n    res: express.Response,\n    next: express.NextFunction\n  ) {\n    res.header(`Access-Control-Allow-Origin`, `*`)\n    res.header(\n      `Access-Control-Allow-Headers`,\n      `Origin, X-Requested-With, Content-Type, Accept`\n    )\n    next()\n  })\n  app.use(pathPrefix, router)\n\n  function printInstructions(appName: string, urls: IPreparedUrls): void {\n    console.log()\n    console.log(`You can now view ${chalk.bold(appName)} in the browser.`)\n    console.log()\n\n    if (urls.lanUrlForTerminal) {\n      console.log(\n        `  ${chalk.bold(`Local:`)}            ${urls.localUrlForTerminal}`\n      )\n      console.log(\n        `  ${chalk.bold(`On Your Network:`)}  ${urls.lanUrlForTerminal}`\n      )\n    } else {\n      console.log(`  ${urls.localUrlForTerminal}`)\n    }\n  }\n\n  const startListening = (): void => {\n    app.listen(port, host, () => {\n      const urls = prepareUrls(\n        program.ssl ? `https` : `http`,\n        program.host,\n        port\n      )\n      printInstructions(\n        program.sitePackageJson.name || `(Unnamed package)`,\n        urls\n      )\n      if (open) {\n        report.info(`Opening browser...`)\n        Promise.resolve(openurl(urls.localUrlForBrowser)).catch(() =>\n          report.warn(`Browser not opened because no browser was found`)\n        )\n      }\n    })\n  }\n\n  try {\n    port = await detectPortInUseAndPrompt(port, program.host)\n    startListening()\n  } catch (e) {\n    if (e.message === `USER_REJECTED`) {\n      return\n    }\n\n    throw e\n  }\n}\n"],"mappings":"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"}